<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼ ê²½ì˜ê²Œì„ í”Œë«í¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ============ LOGIN PAGE ============ */
        .login-page h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .login-page .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 1.05em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .mode-btn .emoji {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .mode-btn h3 {
            margin-bottom: 5px;
        }

        /* ============ WELCOME PAGE ============ */
        .welcome-page {
            text-align: center;
        }

        .welcome-message {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: bold;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .student-info p {
            margin: 8px 0;
            color: #555;
            font-size: 1.05em;
        }

        .game-intro {
            background: #fff3cd;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #ffc107;
        }

        .game-intro h2 {
            color: #856404;
            margin-bottom: 15px;
        }

        .game-intro p {
            color: #856404;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .start-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        /* ============ GAME SELECTION PAGE ============ */
        .game-selection h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 40px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }

        .game-card .emoji {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .game-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .game-card p {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
        }

        /* ============ GAME PAGE ============ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .game-title {
            font-size: 1.8em;
            color: #667eea;
            font-weight: bold;
        }

        .game-stats {
            display: flex;
            gap: 30px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .timer {
            font-size: 1.5em;
            color: #e74c3c;
        }

        .game-content {
            min-height: 400px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .sos-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: fixed;
            bottom: 30px;
            right: 30px;
            font-size: 1em;
            z-index: 1000;
        }

        .sos-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .sos-btn.active {
            background: #28a745;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* ============ GAME SPECIFIC STYLES ============ */
        .question-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .question-number {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .option-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option-btn.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .option-btn.incorrect {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .choice-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }

        .choice-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-option {
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .choice-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .choice-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .choice-risk {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .submit-btn, .next-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 15px;
        }

        .submit-btn:hover, .next-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .feedback.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        /* ============ RESULT PAGE ============ */
        .result-page {
            text-align: center;
        }

        .result-title {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .final-score {
            font-size: 3.5em;
            font-weight: bold;
            margin-bottom: 10px;
            animation: scorePopup 0.5s ease-out;
        }

        @keyframes scorePopup {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .score-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .detail-label {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .detail-value {
            font-size: 1.8em;
            color: #667eea;
            font-weight: bold;
        }

        .back-btn {
            padding: 14px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .back-btn:hover {
            transform: scale(1.05);
        }

        .racing-track {
            display: flex;
            gap: 10px;
            justify-content: space-around;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .car {
            font-size: 3em;
            transition: all 0.3s;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ddd;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 0.9em;
            z-index: 999;
        }

        .firebase-status.connected {
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .firebase-status.disconnected {
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }

        /* ============ í•´ì„¤ íŒì—… ============ */
        #explainPopup {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #explainPopup .popup-inner {
            background: #ffffff;
            padding: 24px 20px;
            border-radius: 16px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        #explainPopup h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        #explainPopup p {
            color: #333;
            font-size: 1em;
            line-height: 1.6;
        }

        #explainPopup button {
            margin-top: 18px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .games-grid {
                grid-template-columns: 1fr;
            }

            .options {
                grid-template-columns: 1fr;
            }

            .game-stats {
                flex-direction: column;
                gap: 15px;
            }

            .result-details {
                grid-template-columns: 1fr;
            }

            .sos-btn {
                padding: 8px 16px;
                font-size: 0.9em;
                bottom: 20px;
                right: 20px;
            }

            .mode-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Status Indicator -->
    <div class="firebase-status disconnected" id="firebaseStatus">
        ğŸ”´ Firebase ì—°ê²° ì¤‘...
    </div>

    <div class="container">
        <!-- ============ MODE SELECTION PAGE ============ -->
        <div class="page login-page active">
            <h1>ğŸ® ê²½ì˜ê²Œì„ í”Œë«í¼</h1>
            <p class="subtitle">ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼ ëª¨ì˜ ê²½ì˜ ì‹œë®¬ë ˆì´ì…˜</p>
            
            <div class="mode-selector">
                <div class="mode-btn selected" onclick="selectMode('student', event)">
                    <div class="emoji">ğŸ‘¨â€ğŸ“</div>
                    <h3>í•™ìƒ ëª¨ë“œ</h3>
                    <p>ê²Œì„ì— ì°¸ì—¬í•˜ê¸°</p>
                </div>
                <div class="mode-btn" onclick="selectMode('professor', event)">
                    <div class="emoji">ğŸ‘¨â€ğŸ«</div>
                    <h3>êµìˆ˜ì ëª¨ë“œ</h3>
                    <p>í•™ìƒ ìƒí™© ëª¨ë‹ˆí„°ë§</p>
                </div>
            </div>

            <!-- Student Login Form -->
            <div id="studentForm">
                <div class="form-group">
                    <label for="studentName">ğŸ‘¤ ì„±ëª…</label>
                    <input type="text" id="studentName" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜">
                </div>

                <div class="form-group">
                    <label for="highSchool">ğŸ« ì¶œì‹ ê³ ë“±í•™êµ</label>
                    <input type="text" id="highSchool" placeholder="ì˜ˆ: OO ê³ ë“±í•™êµ">
                </div>

                <div class="form-group">
                    <label for="email">ğŸ“§ ì´ë©”ì¼</label>
                    <input type="email" id="email" placeholder="ì˜ˆ: student@example.com">
                </div>

                <button class="login-btn" onclick="loginStudent()">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
            </div>

            <!-- Professor Login Form -->
            <div id="professorForm" style="display: none;">
                <div class="form-group">
                    <label for="professorCode">ğŸ” êµìˆ˜ì ì½”ë“œ</label>
                    <input type="password" id="professorCode" placeholder="êµìˆ˜ì ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <button class="login-btn" onclick="loginProfessor()">ëŒ€ì‹œë³´ë“œ ì ‘ì†</button>
            </div>
        </div>

        <!-- ============ WELCOME PAGE ============ -->
        <div class="page welcome-page">
            <div class="welcome-message">í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰</div>
            
            <div class="student-info">
                <p><strong id="welcomeName"></strong>ë‹˜</p>
                <p>ì¶œì‹ í•™êµ: <strong id="welcomeSchool"></strong></p>
                <p>ì´ë©”ì¼: <strong id="welcomeEmail"></strong></p>
            </div>

            <div class="game-intro">
                <h2>ğŸ“‹ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h2>
                <p>âœ… 5ê°€ì§€ ê²½ì˜ ê²Œì„ì— ë„ì „í•˜ì„¸ìš”!</p>
                <p>âœ… ê° ê²Œì„ë§ˆë‹¤ ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”!</p>
                <p>âœ… ì‹œê°„ ì œí•œ: ê° ê²Œì„ë‹¹ ì•½ 2ë¶„</p>
                <p>âœ… ë” ë†’ì€ ì ìˆ˜ë¥¼ ëª©í‘œë¡œ ë„ì „í•˜ì„¸ìš”!</p>
                <p>ğŸ’¡ ê²Œì„ ì¤‘ ê¶ê¸ˆí•˜ë©´ "SOS" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!</p>
            </div>

            <button class="start-btn" onclick="goToGameSelection()">ê²Œì„ ì„ íƒí•˜ê¸°</button>
        </div>

        <!-- ============ GAME SELECTION PAGE ============ -->
        <div class="page game-selection">
            <h1>ğŸ® ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”</h1>
            <div class="games-grid">
                <div class="game-card" onclick="startGame(1)">
                    <div class="emoji">ğŸï¸</div>
                    <h3>ë§ˆì§„ìœ¨ í€´ì¦ˆ ë ˆì´ì‹±</h3>
                    <p>ë§ˆì§„ìœ¨ì„ ê³„ì‚°í•´ì„œ ê°€ì¥ ë¹¨ë¦¬ ë„ì°©í•˜ì„¸ìš”!</p>
                </div>

                <div class="game-card" onclick="startGame(2)">
                    <div class="emoji">ğŸ’°</div>
                    <h3>ê°€ìƒê¸°ì—… ìì›ë°°ë¶„</h3>
                    <p>í•œì •ëœ ìê¸ˆì„ í˜„ëª…í•˜ê²Œ ë°°ë¶„í•˜ì„¸ìš”!</p>
                </div>

                <div class="game-card" onclick="startGame(3)">
                    <div class="emoji">â°</div>
                    <h3>íƒ€ì´ë° ê²½ì˜ ì„ íƒ</h3>
                    <p>ë³€í™”í•˜ëŠ” ìƒí™©ì— ë¹ ë¥´ê²Œ ëŒ€ì‘í•˜ì„¸ìš”!</p>
                </div>

                <div class="game-card" onclick="startGame(4)">
                    <div class="emoji">ğŸ˜Š</div>
                    <h3>ê³ ê°ë§Œì¡±ë„ ê²Œì„</h3>
                    <p>ê³ ê° ë¶ˆë§Œì— ìš°ì„ ìˆœìœ„ë¥¼ ì •í•´ ëŒ€ì‘í•˜ì„¸ìš”!</p>
                </div>

                <div class="game-card" onclick="startGame(5)">
                    <div class="emoji">ğŸ¯</div>
                    <h3>ê²½ìŸì‚¬ ì¶”ê²© ê²Œì„</h3>
                    <p>ê²½ìŸì‚¬ë¥¼ ë”°ë¼ì¡ê³  ì•ì§ˆëŸ¬ ë³´ì„¸ìš”!</p>
                </div>
            </div>
        </div>

        <!-- ============ GAME PAGES ============ -->
        <!-- Game 1: Racing Game -->
        <div class="page game-page" id="game1">
            <div class="game-header">
                <div class="game-title">ğŸï¸ ë§ˆì§„ìœ¨ í€´ì¦ˆ ë ˆì´ì‹±</div>
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-label">ì ìˆ˜</div>
                        <div class="stat-value" id="game1Score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">íƒ€ì´ë¨¸</div>
                        <div class="stat-value timer" id="game1Timer">02:00</div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="racing-track" id="racingTrack">
                    <div class="car">ğŸï¸</div>
                </div>

                <div class="question-container">
                    <div class="question-number">Q<span id="game1QuestionNum">1</span>/5</div>
                    <div class="question-text" id="game1Question"></div>
                    <div class="options" id="game1Options"></div>
                    <button class="submit-btn" onclick="submitGame1Answer()" id="game1SubmitBtn">ë‹µë³€ ì œì¶œ</button>
                    <div class="feedback" id="game1Feedback"></div>
                </div>
            </div>

            <button class="sos-btn" onclick="callSOS('Game1', event)">ğŸ†˜ SOS</button>
        </div>

        <!-- Game 2: Resource Allocation -->
        <div class="page game-page" id="game2">
            <div class="game-header">
                <div class="game-title">ğŸ’° ê°€ìƒê¸°ì—… ìì›ë°°ë¶„</div>
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-label">ì ìˆ˜</div>
                        <div class="stat-value" id="game2Score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">íƒ€ì´ë¨¸</div>
                        <div class="stat-value timer" id="game2Timer">02:00</div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="choice-container">
                    <div class="choice-title" id="game2Scenario"></div>
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p>ğŸ’° ìê¸ˆ: <strong id="game2Budget">1,000ë§Œì›</strong></p>
                        <p>ğŸ“Š ìƒí™©: <strong id="game2Situation"></strong></p>
                    </div>
                </div>

                <div class="choice-container">
                    <div class="choice-title">íˆ¬ì ì „ëµ ì„ íƒ</div>
                    <div class="choice-options" id="game2Options"></div>
                    <button class="submit-btn" onclick="submitGame2Choice()" id="game2SubmitBtn">ì„ íƒ ì™„ë£Œ</button>
                    <div class="feedback" id="game2Feedback"></div>
                </div>
            </div>

            <button class="sos-btn" onclick="callSOS('Game2', event)">ğŸ†˜ SOS</button>
        </div>

        <!-- Game 3: Timing Choice -->
        <div class="page game-page" id="game3">
            <div class="game-header">
                <div class="game-title">â° íƒ€ì´ë° ê²½ì˜ ì„ íƒ</div>
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-label">ì ìˆ˜</div>
                        <div class="stat-value" id="game3Score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">íƒ€ì´ë¨¸</div>
                        <div class="stat-value timer" id="game3Timer">02:00</div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="question-container">
                    <div class="question-number">Q<span id="game3QuestionNum">1</span>/5</div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p>ğŸ“ˆ ì‹œì¥ ìƒí™©: <strong id="game3MarketStatus"></strong></p>
                    </div>
                    <div class="question-text" id="game3Question"></div>
                    <div class="choice-options" id="game3Options"></div>
                    <button class="submit-btn" onclick="submitGame3Choice()" id="game3SubmitBtn">ì„ íƒ ì™„ë£Œ</button>
                    <div class="feedback" id="game3Feedback"></div>
                </div>
            </div>

            <button class="sos-btn" onclick="callSOS('Game3', event)">ğŸ†˜ SOS</button>
        </div>

        <!-- Game 4: Customer Satisfaction -->
        <div class="page game-page" id="game4">
            <div class="game-header">
                <div class="game-title">ğŸ˜Š ê³ ê°ë§Œì¡±ë„ ê²Œì„</div>
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-label">ì ìˆ˜</div>
                        <div class="stat-value" id="game4Score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">íƒ€ì´ë¨¸</div>
                        <div class="stat-value timer" id="game4Timer">02:00</div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="question-container">
                    <div class="question-number">Q<span id="game4QuestionNum">1</span>/5</div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p>ğŸ“Š í˜„ì¬ ê³ ê°ë§Œì¡±ë„: <strong id="game4CurrentScore">85%</strong></p>
                    </div>
                    <div class="question-text" id="game4Question"></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="game4Progress" style="width: 85%;">85%</div>
                    </div>
                    <div class="choice-options" id="game4Options"></div>
                    <button class="submit-btn" onclick="submitGame4Choice()" id="game4SubmitBtn">ëŒ€ì‘ ì™„ë£Œ</button>
                    <div class="feedback" id="game4Feedback"></div>
                </div>
            </div>

            <button class="sos-btn" onclick="callSOS('Game4', event)">ğŸ†˜ SOS</button>
        </div>

        <!-- Game 5: Competitor Chase -->
        <div class="page game-page" id="game5">
            <div class="game-header">
                <div class="game-title">ğŸ¯ ê²½ìŸì‚¬ ì¶”ê²© ê²Œì„</div>
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-label">ì ìˆ˜</div>
                        <div class="stat-value" id="game5Score">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">íƒ€ì´ë¨¸</div>
                        <div class="stat-value timer" id="game5Timer">02:00</div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="question-container">
                    <div class="question-number">R<span id="game5RoundNum">1</span>/5</div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p>ğŸ‘¨â€ğŸ’¼ ìš°ë¦¬ íšŒì‚¬ ë§¤ì¶œ: <strong id="game5MyRevenue">100ë§Œì›</strong></p>
                        <p>ğŸ‘¥ ê²½ìŸì‚¬ ë§¤ì¶œ: <strong id="game5CompRevenue">200ë§Œì›</strong></p>
                    </div>
                    <div class="question-text" id="game5Question"></div>
                    <div class="choice-options" id="game5Options"></div>
                    <button class="submit-btn" onclick="submitGame5Choice()" id="game5SubmitBtn">ì „ëµ ì„ íƒ</button>
                    <div class="feedback" id="game5Feedback"></div>
                </div>
            </div>

            <button class="sos-btn" onclick="callSOS('Game5', event)">ğŸ†˜ SOS</button>
        </div>

        <!-- ============ RESULT PAGE ============ -->
        <div class="page result-page">
            <div class="result-title">ğŸ‰ ê²Œì„ ì™„ë£Œ!</div>
            
            <div class="result-card">
                <div class="final-score" id="finalScore">0</div>
                <div class="score-label">ìµœì¢… ì ìˆ˜</div>
            </div>

            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">ê²Œì„ëª…</div>
                    <div class="detail-value" id="resultGameName">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ì†Œìš”ì‹œê°„</div>
                    <div class="detail-value" id="resultTime">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ì •ë‹µë¥ </div>
                    <div class="detail-value" id="resultAccuracy">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ì„±ì·¨ë„</div>
                    <div class="detail-value" id="resultAchievement">-</div>
                </div>
            </div>

            <p style="color: #666; margin-bottom: 20px; font-size: 1.1em;">
                <strong>ğŸ’¡ ë°°ìš´ì :</strong> ê° ê²Œì„ì„ í†µí•´ ê²½ì˜ ì˜ì‚¬ê²°ì •ì˜ ì¤‘ìš”ì„±ì„ ì´í•´í–ˆìŠµë‹ˆë‹¤!
            </p>

            <button class="back-btn" onclick="backToGameSelection()">ë‹¤ë¥¸ ê²Œì„ ë„ì „í•˜ê¸°</button>
            <button class="back-btn" style="background: #6c757d; margin-left: 10px;" onclick="logout()">ë‚˜ê°€ê¸°</button>
        </div>

        <!-- ============ PROFESSOR DASHBOARD ============ -->
        <div class="page professor-dashboard">
            <h1>ğŸ‘¨â€ğŸ« êµìˆ˜ì ëŒ€ì‹œë³´ë“œ</h1>
            
            <div style="margin-bottom: 30px;">
                <button class="back-btn" style="width: auto; margin-right: 10px;" onclick="refreshDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button class="back-btn" style="background: #6c757d; width: auto;" onclick="logoutProfessor()">ë‚˜ê°€ê¸°</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; color: #667eea; font-weight: bold;" id="totalStudents">0</div>
                    <div style="color: #999;">ì´ í•™ìƒ ìˆ˜</div>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; color: #28a745; font-weight: bold;" id="completedCount">0</div>
                    <div style="color: #999;">ê²Œì„ ì™„ë£Œ</div>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; color: #ffc107; font-weight: bold;" id="sosCount">0</div>
                    <div style="color: #999;">SOS ìš”ì²­</div>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š í•™ìƒ ì§„í–‰ ìƒí™©</h2>
                <div id="studentsList" style="display: grid; grid-template-columns: 1fr; gap: 15px;"></div>
            </div>

            <div>
                <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ†˜ SOS ìš”ì²­ í˜„í™©</h2>
                <div id="sosList" style="display: grid; grid-template-columns: 1fr; gap: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- í•´ì„¤ íŒì—… -->
    <div id="explainPopup">
        <div class="popup-inner">
            <h3>ì •ë‹µ í•´ì„¤</h3>
            <p id="explainText"></p>
            <button onclick="closeExplainPopup()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ============ FIREBASE INITIALIZATION ============
        const firebaseConfig = {
            apiKey: "AIzaSyAxZ-lBhfzdKFVOgAQh-UpoeDgrKFAChIQ",
            authDomain: "biz-simulation-game.firebaseapp.com",
            databaseURL: "https://biz-simulation-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "biz-simulation-game",
            storageBucket: "biz-simulation-game.firebasestorage.app",
            messagingSenderId: "684783051834",
            appId: "1:684783051834:web:e22161ac5498a23ae10103"
        };

        // Firebase ìƒíƒœ í™•ì¸
        let database = null;
        let firebaseReady = false;

        if (typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseReady = true;
                console.log('âœ… Firebase ì—°ê²° ì„±ê³µ!');
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                firebaseReady = false;
            }
        } else {
            console.warn('âš ï¸ Firebase SDK ë¡œë“œ ì‹¤íŒ¨');
        }

        // Firebase ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
        if (firebaseReady && database) {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const statusEl = document.getElementById('firebaseStatus');
                if (statusEl) {
                    if (snap.val() === true) {
                        statusEl.textContent = 'ğŸŸ¢ Firebase ì—°ê²°ë¨';
                        statusEl.classList.remove('disconnected');
                        statusEl.classList.add('connected');
                    } else {
                        statusEl.textContent = 'ğŸ”´ Firebase ì—°ê²° ëŠê¹€';
                        statusEl.classList.remove('connected');
                        statusEl.classList.add('disconnected');
                    }
                }
            });
        }

        // ============ GAME DATA ============
        const gameData = {
            1: {
                name: 'ë§ˆì§„ìœ¨ í€´ì¦ˆ ë ˆì´ì‹±',
                questions: [
                    {
                        text: 'Aìƒí’ˆ: ì›ê°€ 5,000ì› â†’ íŒë§¤ê°€ 10,000ì›, ë§ˆì§„ìœ¨ì€?',
                        options: ['50%', '100%', '150%', '75%'],
                        correct: 1,
                        explanation: 'ë§ˆì§„ìœ¨ = (íŒë§¤ê°€ - ì›ê°€) / ì›ê°€ Ã— 100 ì…ë‹ˆë‹¤. (10,000 - 5,000) / 5,000 Ã— 100 = 100% ì´ë¯€ë¡œ ì •ë‹µì€ 100% ì…ë‹ˆë‹¤.'
                    },
                    {
                        text: 'Bìƒí’ˆ: ì›ê°€ 20,000ì› â†’ íŒë§¤ê°€ 25,000ì›, ë§ˆì§„ìœ¨ì€?',
                        options: ['20%', '25%', '30%', '15%'],
                        correct: 1,
                        explanation: 'ë§ˆì§„ìœ¨ = (25,000 - 20,000) / 20,000 Ã— 100 = 5,000 / 20,000 Ã— 100 = 25% ì…ë‹ˆë‹¤.'
                    },
                    {
                        text: 'Cìƒí’ˆ: ì›ê°€ 40,000ì› â†’ íŒë§¤ê°€ 48,000ì›, ë§ˆì§„ìœ¨ì€?',
                        options: ['15%', '20%', '25%', '10%'],
                        correct: 1,
                        explanation: 'ë§ˆì§„ìœ¨ = (48,000 - 40,000) / 40,000 Ã— 100 = 8,000 / 40,000 Ã— 100 = 20% ì…ë‹ˆë‹¤.'
                    },
                    {
                        text: 'Dìƒí’ˆ: ì›ê°€ 1,000ì› â†’ íŒë§¤ê°€ 3,000ì›, ë§ˆì§„ìœ¨ì€?',
                        options: ['100%', '150%', '200%', '250%'],
                        correct: 2,
                        explanation: 'ë§ˆì§„ìœ¨ = (3,000 - 1,000) / 1,000 Ã— 100 = 2,000 / 1,000 Ã— 100 = 200% ì…ë‹ˆë‹¤.'
                    },
                    {
                        text: 'Eìƒí’ˆ: ì›ê°€ 80,000ì› â†’ íŒë§¤ê°€ 96,000ì›, ë§ˆì§„ìœ¨ì€?',
                        options: ['15%', '20%', '25%', '10%'],
                        correct: 1,
                        explanation: 'ë§ˆì§„ìœ¨ = (96,000 - 80,000) / 80,000 Ã— 100 = 16,000 / 80,000 Ã— 100 = 20% ì…ë‹ˆë‹¤.'
                    }
                ]
            },
            2: {
                name: 'ê°€ìƒê¸°ì—… ìì›ë°°ë¶„',
                scenarios: [
                    {
                        situation: 'ê²½ê¸° í˜¸í™© ì‹œê¸°',
                        question: 'ì´ˆê¸° ìê¸ˆ 1,000ë§Œì›ì„ ì–´ë””ì— íˆ¬ìí• ê¹Œìš”?',
                        choices: [
                            { text: 'ê´‘ê³ ì— ì§‘ì¤‘ (700ë§Œ)', effect: '+30% ë§¤ì¶œ, -10% ê¸°ìˆ ' },
                            { text: 'R&D íˆ¬ì (700ë§Œ)', effect: '+20% ê¸°ìˆ , -5% ë‹¨ê¸°ë§¤ì¶œ' },
                            { text: 'ì¸ë ¥ ì±„ìš© (700ë§Œ)', effect: '+15% ëª¨ë“  ì§€í‘œ' },
                            { text: 'ê· í˜• íˆ¬ì (300/350/350)', effect: '+15% ê· í˜•ìˆëŠ” ì„±ì¥' }
                        ],
                        correct: 0,
                        explanation: 'ê²½ê¸° í˜¸í™©ê¸°ì—ëŠ” ì†Œë¹„ ì‹¬ë¦¬ê°€ ì¢‹ì•„ ê´‘ê³  íš¨ê³¼ê°€ íŠ¹íˆ í½ë‹ˆë‹¤. ê´‘ê³ ì— ì§‘ì¤‘í•˜ë©´ ë‹¨ê¸°ê°„ ë§¤ì¶œì„ í¬ê²Œ ì˜¬ë¦´ ìˆ˜ ìˆì–´ ê°€ì¥ ì í•©í•œ ì „ëµìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                    },
                    {
                        situation: 'ê²½ê¸° ì¹¨ì²´ ì‹œê¸°',
                        question: 'ìê¸ˆ í™•ë³´ í›„ ì–´ë””ë¥¼ ìš°ì„ ìœ¼ë¡œ?',
                        choices: [
                            { text: 'ê´‘ê³ ëŠ” ìµœì†Œí™”', effect: '-5% ë§¤ì¶œ, +10% í˜„ê¸ˆ' },
                            { text: 'R&DëŠ” ê³„ì†', effect: 'í–¥í›„ ê²½ìŸë ¥ +20%' },
                            { text: 'ì¸ë ¥ ê°ì›', effect: '+5% ì´ìœ¤, -10% ì—­ëŸ‰' },
                            { text: 'ëª¨ë“  ì˜ì—­ ì¶•ì†Œ', effect: 'ìƒì¡´, íšŒë³µ ì§€ì—°' }
                        ],
                        correct: 1,
                        explanation: 'ë¶ˆí™©ê¸°ì—ëŠ” ë‹¹ì¥ ë§¤ì¶œì€ ì¤„ë”ë¼ë„ R&Dë¥¼ ìœ ì§€í•˜ë©´ ì´í›„ ê²½ê¸°ê°€ íšŒë³µë  ë•Œ ê²½ìŸì‚¬ë³´ë‹¤ ë” í° ê²½ìŸë ¥ì„ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¥ê¸°ì ì¸ ê´€ì ì—ì„œ ê°€ì¥ ì¢‹ì€ ì„ íƒì…ë‹ˆë‹¤.'
                    },
                    {
                        situation: 'ì‹ ì œí’ˆ ì¶œì‹œ ì˜ˆì •',
                        question: 'íˆ¬ì ì „ëµì€?',
                        choices: [
                            { text: 'ê´‘ê³ ì— 900ë§Œ íˆ¬ì', effect: 'ë¹ ë¥¸ ì„±ì¥, ë†’ì€ ìœ„í—˜' },
                            { text: 'R&Dì— 900ë§Œ íˆ¬ì', effect: 'í’ˆì§ˆ ìš°ìˆ˜, ëŠë¦° ì‹œì¥ì§„ì…' },
                            { text: 'ê· í˜• íˆ¬ì (450/450)', effect: 'ì•ˆì •ì  ì„±ì¥' },
                            { text: 'í˜„ê¸ˆ ë³´ìœ ', effect: 'ê¸°íšŒìƒì‹¤' }
                        ],
                        correct: 2,
                        explanation: 'ì‹ ì œí’ˆ ì¶œì‹œ ì „ì—ëŠ” í’ˆì§ˆê³¼ í™ë³´ ë‘˜ ë‹¤ ì¤‘ìš”í•©ë‹ˆë‹¤. R&Dì™€ ê´‘ê³ ë¥¼ ì ì ˆíˆ ë‚˜ëˆ„ì–´ íˆ¬ìí•˜ëŠ” ê· í˜• íˆ¬ì ì „ëµì´ ê°€ì¥ ì•ˆì •ì ì´ê³  í˜„ì‹¤ì ì¸ ì„ íƒì…ë‹ˆë‹¤.'
                    },
                    {
                        situation: 'ê²½ìŸì‚¬ ëŒ€ì‘ í•„ìš”',
                        question: 'ê²½ìŸì‚¬ ê³µê²©ì— ì–´ë–»ê²Œ ëŒ€ì‘?',
                        choices: [
                            { text: 'ê´‘ê³  ì „ìŸ (800ë§Œ)', effect: 'ë‹¨ê¸° íš¨ê³¼, ì¥ê¸° ì•½í™”' },
                            { text: 'ê¸°ìˆ í˜ì‹  (800ë§Œ)', effect: 'ì°¨ë³„í™”, ì‹œê°„ í•„ìš”' },
                            { text: 'ê°€ê²©ì¸í•˜ (800ë§Œ)', effect: 'íŒë§¤ì¦ê°€, ì´ìœ¤ê°ì†Œ' },
                            { text: 'ê· í˜• ëŒ€ì‘', effect: 'ì•ˆì •ì  ì§€ì†ì„±' }
                        ],
                        correct: 1,
                        explanation: 'ê²½ìŸì‚¬ê°€ ê³µê²©í•´ ì˜¬ ë•Œ ë‹¨ê¸° ê´‘ê³ ë‚˜ ê°€ê²© ì¸í•˜ë³´ë‹¤, ê¸°ìˆ  í˜ì‹ ìœ¼ë¡œ ì œí’ˆê³¼ ì„œë¹„ìŠ¤ë¥¼ ì°¨ë³„í™”í•˜ë©´ ì¥ê¸°ì ìœ¼ë¡œ ìš°ìœ„ì— ì„¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                    },
                    {
                        situation: 'ì„±ê³µ í›„ í™•ì¥ ê¸°íšŒ',
                        question: 'ì„±ì¥ì„ ìœ„í•œ ìµœê³ ì˜ ì „ëµì€?',
                        choices: [
                            { text: 'ë§¤ì¥ í™•ëŒ€ (ì¸ë ¥)', effect: 'ë¹ ë¥¸ í™•ì¥' },
                            { text: 'ê¸°ìˆ  ê³ ë„í™” (R&D)', effect: 'ê²½ìŸë ¥ ê°•í™”' },
                            { text: 'ë¸Œëœë“œ ê°•í™” (ê´‘ê³ )', effect: 'ì´ë¯¸ì§€ ê°œì„ ' },
                            { text: 'ì†Œìˆ˜ì •ì˜ˆ ìš´ì˜', effect: 'ë†’ì€ ì´ìœ¤ìœ¨' }
                        ],
                        correct: 1,
                        explanation: 'ì„±ê³µ í›„ì—ëŠ” ë‹¨ìˆœí•œ ê·œëª¨ í™•ì¥ë³´ë‹¤ ê¸°ìˆ  ê³ ë„í™”ë¥¼ í†µí•´ ê²½ìŸìê°€ ì‰½ê²Œ ë”°ë¼ì˜¬ ìˆ˜ ì—†ëŠ” ê¸°ë°˜ì„ ë§Œë“œëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.'
                    }
                ]
            },
            3: {
                name: 'íƒ€ì´ë° ê²½ì˜ ì„ íƒ',
                scenarios: [
                    {
                        market: 'ğŸ“ˆ í˜¸í™©ê¸°',
                        question: 'ì‹œì¥ì´ í™œë°œí•©ë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ê³µê²©ì ìœ¼ë¡œ ì¬ê³  ì¦ê°€', effect: 'ìœ„í—˜ë„ ë†’ìŒ, ìˆ˜ìµ +50%' },
                            { text: 'ê°€ê²© ìœ ì§€ & íŒë§¤ ê·¹ëŒ€í™”', effect: 'ìœ„í—˜ë„ ì¤‘ê°„, ìˆ˜ìµ +30%' },
                            { text: 'ì•ˆì •ì ìœ¼ë¡œ ê°€ê²© ìœ ì§€', effect: 'ìœ„í—˜ë„ ë‚®ìŒ, ìˆ˜ìµ +15%' },
                            { text: 'ì‹ ì œí’ˆ ê°œë°œì— ì§‘ì¤‘', effect: 'ì¥ê¸°ìˆ˜ìµ +40%' }
                        ],
                        correct: 1,
                        explanation: 'í˜¸í™©ê¸°ì—ëŠ” êµ³ì´ í° ìœ„í—˜ì„ ì§€ì§€ ì•Šì•„ë„ ì˜ íŒ”ë¦½ë‹ˆë‹¤. ê°€ê²©ì€ ìœ ì§€í•˜ë©´ì„œ íŒë§¤ëŸ‰ì„ ê·¹ëŒ€í™”í•˜ëŠ” ì „ëµì´ ìˆ˜ìµì„±ê³¼ ì•ˆì •ì„±ì„ ë™ì‹œì— ì¡ëŠ” ì„ íƒì…ë‹ˆë‹¤.'
                    },
                    {
                        market: 'ğŸ“‰ ë¶ˆí™©ê¸°',
                        question: 'ì‹œì¥ì´ ì¹¨ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ì ê·¹ì  í• ì¸ íŒë§¤', effect: 'íŒë§¤ëŸ‰ ì¦ê°€, ì´ìœ¤ ê°ì†Œ' },
                            { text: 'ê°€ê²© ìœ ì§€ & ê³ ê° ê´€ë¦¬', effect: 'ê· í˜•ìˆëŠ” ëŒ€ì‘' },
                            { text: 'ì‹ ìƒí’ˆ ëŸ°ì¹­', effect: 'ìƒˆë¡œìš´ ê¸°íšŒ' },
                            { text: 'í˜„ê¸ˆ ë³´ìœ ', effect: 'ì•ˆì „, ê¸°íšŒìƒì‹¤' }
                        ],
                        correct: 1,
                        explanation: 'ë¶ˆí™©ê¸°ì—ëŠ” ë¬´ë¦¬í•œ í• ì¸ë³´ë‹¤ ê¸°ì¡´ ê³ ê°ì„ ì˜ ê´€ë¦¬í•˜ë©° ì‹ ë¢°ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ê°€ê²©ì„ í¬ê²Œ í”ë“¤ì§€ ì•Šê³  ê´€ê³„ë¥¼ ì§€í‚¤ëŠ” ì „ëµì…ë‹ˆë‹¤.'
                    },
                    {
                        market: 'ğŸ”„ ë³€ë™ê¸°',
                        question: 'ì‹œì¥ì´ ê³„ì† ë³€í•©ë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ë¹ ë¥´ê²Œ ëŒ€ì‘í•˜ê¸°', effect: 'ê¸°íšŒ í¬ì°©' },
                            { text: 'ì¶”ì„¸ ë¶„ì„í•˜ê¸°', effect: 'ì‹ ì¤‘í•œ íŒë‹¨' },
                            { text: 'ê°€ê²© ì¡°ì •í•˜ê¸°', effect: 'ê²½ìŸë ¥ ìœ ì§€' },
                            { text: 'ê´€ë§í•˜ê¸°', effect: 'ê¸°íšŒìƒì‹¤' }
                        ],
                        correct: 0,
                        explanation: 'ì‹œì¥ì´ ìì£¼ ë°”ë€” ë•ŒëŠ” ëŠë¦¬ê²Œ ì›€ì§ì´ë©´ ê¸°íšŒë¥¼ ë†“ì¹©ë‹ˆë‹¤. ë¹ ë¥´ê²Œ ì‹¤í—˜í•˜ê³  ë°˜ì‘í•˜ëŠ” ë¯¼ì²©ì„±ì´ í•µì‹¬ì…ë‹ˆë‹¤.'
                    },
                    {
                        market: 'â­ í™•ì¥ê¸°',
                        question: 'ì‹œì¥ì´ í¬ê²Œ í™•ëŒ€ë©ë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ì‹œì¥ì ìœ ìœ¨ í™•ë³´ (ê³µê²©)', effect: 'ì¥ê¸° ìš°ìœ„' },
                            { text: 'ì´ìœ¤ ìš°ì„  (ë°©ì–´)', effect: 'ë‹¨ê¸° ìˆ˜ìµì„±' },
                            { text: 'ê¸°ìˆ  íˆ¬ì', effect: 'ê²½ìŸë ¥ ê°•í™”' },
                            { text: 'í˜„ìƒ ìœ ì§€', effect: 'ê¸°íšŒìƒì‹¤' }
                        ],
                        correct: 0,
                        explanation: 'ì‹œì¥ì´ ì»¤ì§ˆ ë•ŒëŠ” ë¨¼ì € ì ìœ ìœ¨ì„ í™•ë³´í•˜ëŠ” ê¸°ì—…ì´ ì´í›„ ì´ìœ¤ë„ í¬ê²Œ ê°€ì ¸ê°‘ë‹ˆë‹¤. ê³µê²©ì ìœ¼ë¡œ ì‹œì¥ì„ ë„“íˆëŠ” ì „ëµì´ ì¥ê¸° ìš°ìœ„ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
                    },
                    {
                        market: 'âš¡ ê¸‰ë³€ê¸°',
                        question: 'ê·œì¹™ì´ ë°”ë€ë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ìƒˆ ê·œì¹™ í•™ìŠµ & ë¹ ë¥¸ ì ì‘', effect: 'ì„ ë„ ê¸°ì—…' },
                            { text: 'ê¸°ì¡´ ë°©ì‹ ìœ ì§€', effect: 'ë’¤ì²˜ì§' },
                            { text: 'ë¡œë¹„í™œë™', effect: 'ë¦¬ìŠ¤í¬ ì¦ê°€' },
                            { text: 'ì‹œì¥ ì¬ì§„ì… ì¤€ë¹„', effect: 'ëŠ¦ì€ ëŒ€ì‘' }
                        ],
                        correct: 0,
                        explanation: 'ê·œì¹™ì´ ë°”ë€Œë©´ ê°€ì¥ ë¨¼ì € ì´í•´í•˜ê³  ì ìš©í•˜ëŠ” íšŒì‚¬ê°€ ìƒˆ ê²Œì„ì˜ ìŠ¹ìê°€ ë©ë‹ˆë‹¤. ë³€í™”ë¥¼ ë¹¨ë¦¬ í•™ìŠµí•˜ê³  ì ìš©í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.'
                    }
                ]
            },
            4: {
                name: 'ê³ ê°ë§Œì¡±ë„ ê²Œì„',
                scenarios: [
                    {
                        complaints: [
                            { issue: 'ë°°ì†¡ ì§€ì—°', severity: 'ë†’ìŒ' },
                            { issue: 'ì œí’ˆ í’ˆì§ˆ ë¬¸ì œ', severity: 'ë†’ìŒ' },
                            { issue: 'A/S ì‘ë‹µ ì§€ì—°', severity: 'ì¤‘ê°„' }
                        ],
                        question: 'ì–´ë–¤ ë¬¸ì œë¥¼ ë¨¼ì € í•´ê²°í• ê¹Œìš”?',
                        choices: [
                            { text: 'ë°°ì†¡ ì§€ì—° ê°œì„ ', effect: '+20% ë§Œì¡±ë„' },
                            { text: 'í’ˆì§ˆ ë¬¸ì œ í•´ê²°', effect: '+25% ë§Œì¡±ë„ (ìµœê³ )' },
                            { text: 'A/S ê°œì„ ', effect: '+10% ë§Œì¡±ë„' },
                            { text: 'ì„¸ ê°€ì§€ ëª¨ë‘', effect: '+50% ë§Œì¡±ë„' }
                        ],
                        correct: 1,
                        currentSatisfaction: 70,
                        explanation: 'ì œí’ˆ í’ˆì§ˆì´ ê°€ì¥ ê¸°ë³¸ì…ë‹ˆë‹¤. í’ˆì§ˆ ë¬¸ì œê°€ ê³„ì†ë˜ë©´ ì•„ë¬´ë¦¬ ë°°ì†¡ì´ ë¹¨ë¼ì ¸ë„ ê³ ê°ì´ ë– ë‚˜ê¸° ë•Œë¬¸ì—, í’ˆì§ˆ ê°œì„ ì´ ìµœìš°ì„  ê³¼ì œì…ë‹ˆë‹¤.'
                    },
                    {
                        complaints: [
                            { issue: 'ê°€ê²©ì´ ë¹„ìŒˆ', severity: 'ë†’ìŒ' },
                            { issue: 'ë°°ì†¡ ëŠë¦¼', severity: 'ì¤‘ê°„' },
                            { issue: 'ìƒí’ˆ ë‹¤ì–‘ì„± ë¶€ì¡±', severity: 'ì¤‘ê°„' }
                        ],
                        question: 'ê³ ê°ë“¤ì´ ë¶ˆë§Œì…ë‹ˆë‹¤. ìš°ì„ ìˆœìœ„ëŠ”?',
                        choices: [
                            { text: 'ê°€ê²© ì¸í•˜', effect: '+30% ë§Œì¡±ë„' },
                            { text: 'ë°°ì†¡ ì†ë„ ê°œì„ ', effect: '+15% ë§Œì¡±ë„' },
                            { text: 'ìƒí’ˆ ë‹¤ì–‘í™”', effect: '+20% ë§Œì¡±ë„' },
                            { text: 'ëª¨ë‘ í•¨ê»˜ ê°œì„ ', effect: '+65% ë§Œì¡±ë„' }
                        ],
                        correct: 0,
                        currentSatisfaction: 60,
                        explanation: 'ì´ ìƒí™©ì—ì„œ ê³ ê°ì˜ ê°€ì¥ í° ë¶ˆë§Œì€ â€œë„ˆë¬´ ë¹„ì‹¸ë‹¤â€ì…ë‹ˆë‹¤. í•µì‹¬ ë¶ˆë§Œë¶€í„° í•´ê²°í•´ì•¼ ì²´ê° ë§Œì¡±ë„ê°€ í™• ì˜¬ë¼ê°‘ë‹ˆë‹¤.'
                    },
                    {
                        complaints: [
                            { issue: 'ê³ ê° ìƒë‹´ ë¶€ì¬', severity: 'ë†’ìŒ' },
                            { issue: 'ë°˜í’ˆ ì ˆì°¨ ë³µì¡', severity: 'ì¤‘ê°„' },
                            { issue: 'ì œí’ˆ ì •ë³´ ë¶€ì¡±', severity: 'ì¤‘ê°„' }
                        ],
                        question: 'ì„œë¹„ìŠ¤ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ì–´ë–»ê²Œ?',
                        choices: [
                            { text: '24ì‹œê°„ ìƒë‹´ ê°œì„¤', effect: '+30% ë§Œì¡±ë„' },
                            { text: 'ë°˜í’ˆ ì ˆì°¨ ê°„ì†Œí™”', effect: '+20% ë§Œì¡±ë„' },
                            { text: 'ìƒì„¸ ì •ë³´ ì œê³µ', effect: '+15% ë§Œì¡±ë„' },
                            { text: 'ì „ì²´ ê°œì„ ', effect: '+65% ë§Œì¡±ë„' }
                        ],
                        correct: 0,
                        currentSatisfaction: 65,
                        explanation: 'ê³ ê°ì´ ë¬¸ì˜í•  ì°½êµ¬ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë¶ˆë§Œì´ ìŒ“ì…ë‹ˆë‹¤. ìƒë‹´ ì±„ë„ì„ ì—´ì–´ì£¼ëŠ” ê²ƒì´ ê°€ì¥ ê¸‰í•œ ë¬¸ì œì…ë‹ˆë‹¤.'
                    },
                    {
                        complaints: [
                            { issue: 'ì„ ì£¼ë¬¸ í’ˆì ˆ ë¹ˆë²ˆ', severity: 'ë†’ìŒ' },
                            { issue: 'ë°°ì†¡ ì†ìƒ', severity: 'ë†’ìŒ' },
                            { issue: 'ë³´ìƒ ì •ì±… ë¶ˆëª…í™•', severity: 'ì¤‘ê°„' }
                        ],
                        question: 'ì‹¬ê°í•œ ë¬¸ì œë“¤ì…ë‹ˆë‹¤. ìš°ì„  ìˆœìœ„?',
                        choices: [
                            { text: 'ì¬ê³  ê´€ë¦¬ ê°œì„ ', effect: '+25% ë§Œì¡±ë„' },
                            { text: 'ë°°ì†¡ í¬ì¥ ê°•í™”', effect: '+22% ë§Œì¡±ë„' },
                            { text: 'ë³´ìƒ ì •ì±… ëª…í™•í™”', effect: '+18% ë§Œì¡±ë„' },
                            { text: 'ëª¨ë‘ í•¨ê»˜ í•´ê²°', effect: '+70% ë§Œì¡±ë„' }
                        ],
                        correct: 3,
                        currentSatisfaction: 50,
                        explanation: 'ì´ ê²½ìš°ëŠ” í•˜ë‚˜ë§Œ ì†ë³´ë©´ ë˜ëŠ” ìˆ˜ì¤€ì´ ì•„ë‹ˆë¼, ì „ë°˜ì ì¸ í”„ë¡œì„¸ìŠ¤ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ì „ë©´ì ì¸ ê°œì„ ì´ ê°€ì¥ íš¨ê³¼ì ì…ë‹ˆë‹¤.'
                    },
                    {
                        complaints: [
                            { issue: 'ë¸Œëœë“œ ì´ë¯¸ì§€ í•˜ë½', severity: 'ë†’ìŒ' },
                            { issue: 'ë‹¨ê³¨ ê³ ê° ê°ì†Œ', severity: 'ë†’ìŒ' },
                            { issue: 'ë¦¬ë·° í‰ì  ì €í•˜', severity: 'ë†’ìŒ' }
                        ],
                        question: 'ìœ„ê¸° ìƒí™©ì…ë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ê´‘ê³  ìº í˜ì¸ ê°•í™”', effect: '+20% ë§Œì¡±ë„' },
                            { text: 'ë¡œì—´í‹° í”„ë¡œê·¸ë¨ ê°œì„¤', effect: '+25% ë§Œì¡±ë„' },
                            { text: 'í’ˆì§ˆ ê°œì„  ì§‘ì¤‘', effect: '+30% ë§Œì¡±ë„' },
                            { text: 'ì „ì²´ ì´ë¯¸ì§€ í˜ì‹ ', effect: '+75% ë§Œì¡±ë„' }
                        ],
                        correct: 3,
                        currentSatisfaction: 40,
                        explanation: 'ë‹¨ìˆœ ì´ë²¤íŠ¸ë‚˜ ê´‘ê³ ë¡œëŠ” íšŒë³µì´ ì–´ë µìŠµë‹ˆë‹¤. ì œí’ˆ, ì„œë¹„ìŠ¤, ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì„ ëª¨ë‘ ì†ë³´ëŠ” ë¸Œëœë“œ ë¦¬ë‰´ì–¼ ìˆ˜ì¤€ì˜ í˜ì‹ ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                    }
                ]
            },
            5: {
                name: 'ê²½ìŸì‚¬ ì¶”ê²© ê²Œì„',
                scenarios: [
                    {
                        myRevenue: 100,
                        compRevenue: 200,
                        question: 'ê²½ìŸì‚¬ê°€ 2ë°° ì•ì„œ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?',
                        choices: [
                            { text: 'ê³µê²©ì  ê°€ê²©ì¸í•˜ (ê³µê²©)', effect: 'ë§¤ì¶œ +50%, ì´ìœ¤ -20%' },
                            { text: 'ê¸°ìˆ  ì°¨ë³„í™” (ì „ëµ)', effect: 'ë§¤ì¶œ +30%, ì´ìœ¤ +10%' },
                            { text: 'ì„œë¹„ìŠ¤ ê°œì„  (ì•ˆì •)', effect: 'ë§¤ì¶œ +20%, ì´ìœ¤ +5%' },
                            { text: 'ëª¨ë“  ì˜ì—­ ê°•í™” (ì ê·¹)', effect: 'ë§¤ì¶œ +35%, ì´ìœ¤ -5%' }
                        ]
                    },
                    {
                        myRevenue: 120,
                        compRevenue: 180,
                        question: 'ê²©ì°¨ê°€ ì¤„ì–´ë“¤ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì „ëµì€?',
                        choices: [
                            { text: 'ê³µê²©ë ¥ ìœ ì§€', effect: 'ë§¤ì¶œ +40%, ìœ„í—˜ë„ ë†’ìŒ' },
                            { text: 'ê¸°ìˆ  ê°•í™”', effect: 'ì¥ê¸° ê²½ìŸë ¥ +50%' },
                            { text: 'ê³ ê° ì¶©ì„±ë„', effect: 'ì•ˆì •ì  ì„±ì¥ +25%' },
                            { text: 'ì‹œì¥ í™•ëŒ€', effect: 'ìƒˆë¡œìš´ ê¸°íšŒ +30%' }
                        ]
                    },
                    {
                        myRevenue: 150,
                        compRevenue: 160,
                        question: 'ê±°ì˜ ë”°ë¼ì¡ì•˜ìŠµë‹ˆë‹¤!',
                        choices: [
                            { text: 'ë§ˆì§€ë§‰ ê³µê²© (ê³ ìœ„í—˜)', effect: 'ì•ì¶” ê°€ëŠ¥ +60%, ì†ì‹¤ -40%' },
                            { text: 'ê· í˜•ìˆëŠ” ì¶”ê²©', effect: 'ì•ì¶” ê°€ëŠ¥ +40%, ì•ˆì •ì„± ë†’ìŒ' },
                            { text: 'ì°¨ë³„í™” ì „ëµ', effect: 'ì•ì¶” ê°€ëŠ¥ +35%, ê²½ìŸë ¥ ê°•í™”' },
                            { text: 'ì¸ìˆ˜í•©ë³‘ ê²€í† ', effect: 'ì¦‰ì‹œ 1ìœ„' }
                        ]
                    },
                    {
                        myRevenue: 180,
                        compRevenue: 150,
                        question: 'ìš°ë¦¬ê°€ ì•ì§ˆë €ìŠµë‹ˆë‹¤!',
                        choices: [
                            { text: 'ê³µê²© ê³„ì†', effect: 'ë” ì•ì„œê¸°, ê²½ìŸ ì‹¬í™”' },
                            { text: 'ì´ìœ¤ ìš°ì„ ', effect: 'ë‹¨ê¸° ìˆ˜ìµì„± +40%' },
                            { text: 'ê¸°ìˆ  íˆ¬ì', effect: 'ì¥ê¸° ìš°ìœ„ êµ¬ì¶•' },
                            { text: 'ì‹œì¥ ì§€ë°°ë ¥', effect: '1ìœ„ ìœ ì§€ +80%' }
                        ]
                    },
                    {
                        myRevenue: 200,
                        compRevenue: 100,
                        question: 'ìš°ë¦¬ê°€ ì••ë„ì  1ìœ„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!',
                        choices: [
                            { text: 'ê³µê²©ì  í™•ì¥', effect: 'ì‹œì¥ ì§€ë°°, ê·œì œ ë¦¬ìŠ¤í¬' },
                            { text: 'í˜ì‹ ì— ì§‘ì¤‘', effect: 'ê²½ìŸë ¥ ì§€ì†' },
                            { text: 'ìƒˆë¡œìš´ ì‹œì¥ ì§„ì¶œ', effect: '+30% ì¶”ê°€ ì„±ì¥' },
                            { text: 'ê³ ê° ë§Œì¡± ìµœìš°ì„ ', effect: '1ìœ„ ìœ ì§€, ì•ˆì •ì„± +50%' }
                        ]
                    }
                ]
            }
        };

        // ============ STATE MANAGEMENT ============
        let currentGame = null;
        let currentQuestion = 0;
        let score = 0;
        let totalAnswered = 0;
        let correctAnswers = 0;
        let gameStartTime = null;
        let gameEndTime = null;
        let timerInterval = null;
        let timeLeft = 120;
        let selectedAnswer = null;
        let userMode = 'student';
        let studentInfo = {
            name: '',
            school: '',
            email: '',
            sessionId: ''
        };
        let professorMode = false;

        // ============ í•´ì„¤ íŒì—… í•¨ìˆ˜ ============
        function showExplainPopup(text) {
            const popup = document.getElementById('explainPopup');
            const explainText = document.getElementById('explainText');
            if (explainText) explainText.textContent = text;
            if (popup) popup.style.display = 'flex';
        }

        function closeExplainPopup() {
            const popup = document.getElementById('explainPopup');
            if (popup) popup.style.display = 'none';
        }

        // ============ PAGE NAVIGATION ============
        function showPage(selector) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.querySelector(selector);
            if (target) {
                target.classList.add('active');
            } else {
                console.error('í˜ì´ì§€ ì„ íƒì ì˜¤ë¥˜:', selector);
            }
        }

        function selectMode(mode, ev) {
            userMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('selected'));
            if (ev && ev.currentTarget) {
                ev.currentTarget.classList.add('selected');
            }

            if (mode === 'student') {
                document.getElementById('studentForm').style.display = 'block';
                document.getElementById('professorForm').style.display = 'none';
            } else {
                document.getElementById('studentForm').style.display = 'none';
                document.getElementById('professorForm').style.display = 'block';
            }
        }

        function loginStudent() {
            const name = document.getElementById('studentName').value.trim();
            const school = document.getElementById('highSchool').value.trim();
            const email = document.getElementById('email').value.trim();

            if (!name || !school || !email) {
                alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            studentInfo = { 
                name, 
                school, 
                email,
                sessionId: generateSessionId()
            };
            
            saveStudentInfo(studentInfo.sessionId, name, school, email);

            document.getElementById('welcomeName').textContent = name;
            document.getElementById('welcomeSchool').textContent = school;
            document.getElementById('welcomeEmail').textContent = email;

            showPage('.welcome-page');
        }

        function loginProfessor() {
            const code = document.getElementById('professorCode').value.trim();
            
            if (code === '1234') {
                professorMode = true;
                loadProfessorDashboard();
                showPage('.professor-dashboard');
            } else {
                alert('êµìˆ˜ì ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function goToGameSelection() {
            showPage('.game-selection');
        }

        function backToGameSelection() {
            currentGame = null;
            currentQuestion = 0;
            selectedAnswer = null;
            if (timerInterval) clearInterval(timerInterval);
            showPage('.game-selection');
        }

        function logout() {
            if (firebaseReady && database && studentInfo.sessionId) {
                database.ref('students/' + studentInfo.sessionId + '/status').set('completed');
            }

            currentGame = null;
            currentQuestion = 0;
            score = 0;
            selectedAnswer = null;
            if (timerInterval) clearInterval(timerInterval);
            
            document.getElementById('studentName').value = '';
            document.getElementById('highSchool').value = '';
            document.getElementById('email').value = '';
            document.getElementById('professorCode').value = '';
            
            showPage('.login-page');
        }

        function logoutProfessor() {
            professorMode = false;
            document.getElementById('professorCode').value = '';
            showPage('.login-page');
        }

        // ============ PROFESSOR DASHBOARD ============
        function loadProfessorDashboard() {
            if (!firebaseReady || !database) return;

            database.ref('students').on('value', (snapshot) => {
                const students = snapshot.val() || {};
                let totalCount = 0;
                let completedCount = 0;
                let sosCount = 0;
                let studentsList = '';

                for (let sessionId in students) {
                    const student = students[sessionId];
                    totalCount++;

                    if (student.status === 'completed') {
                        completedCount++;
                    }

                    studentsList += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid ${
                            student.status === 'completed' ? '#28a745' : '#ffc107'
                        }">
                            <strong>${student.name}</strong> (${student.school})<br>
                            ğŸ“§ ${student.email}<br>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                                ìƒíƒœ: <span style="color: ${student.status === 'completed' ? '#28a745' : '#ffc107'}">${
                                    student.status === 'completed' ? 'âœ… ì™„ë£Œ' : 'ğŸ”„ ì§„í–‰ ì¤‘'
                                }</span>
                                | ì ìˆ˜: <strong>${student.score || 0}ì </strong>
                                | ê²Œì„: ${student.currentGame || 'none'}
                            </div>
                        </div>
                    `;

                    if (student.sosRequests && student.sosRequests.length > 0) {
                        sosCount += student.sosRequests.length;
                    }
                }

                document.getElementById('totalStudents').textContent = totalCount;
                document.getElementById('completedCount').textContent = completedCount;
                document.getElementById('sosCount').textContent = sosCount;
                document.getElementById('studentsList').innerHTML = studentsList || '<p>í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            });

            database.ref('sos').on('value', (snapshot) => {
                const sosRequests = snapshot.val() || {};
                let sosList = '';

                for (let requestId in sosRequests) {
                    const request = sosRequests[requestId];
                    sosList += `
                        <div style="background: #ffe5e5; padding: 15px; border-radius: 10px; border-left: 4px solid #e74c3c;">
                            <strong>ğŸ†˜ ${request.studentName}</strong><br>
                            ê²Œì„: ${request.game}<br>
                            ì‹œê°„: ${new Date(request.timestamp).toLocaleTimeString('ko-KR')}<br>
                            <button class="back-btn" style="width: auto; margin-top: 10px;" onclick="resolveSOSRequest('${requestId}')">í•´ê²°ë¨</button>
                        </div>
                    `;
                }

                document.getElementById('sosList').innerHTML = sosList || '<p>SOS ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
        }

        function refreshDashboard() {
            loadProfessorDashboard();
            alert('ëŒ€ì‹œë³´ë“œê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ============ GAME INITIALIZATION ============
        function startGame(gameNum) {
            currentGame = gameNum;
            currentQuestion = 0;
            score = 0;
            totalAnswered = 0;
            correctAnswers = 0;
            selectedAnswer = null;
            timeLeft = 120;
            gameStartTime = new Date();

            if (firebaseReady && studentInfo.sessionId) {
                updateGameStatus(studentInfo.sessionId, gameData[gameNum].name, 0);
            }

            document.querySelectorAll('.game-page').forEach(p => p.style.display = 'none');
            document.getElementById('game' + gameNum).style.display = 'block';
            
            showPage('#game' + gameNum);
            
            if (gameNum === 1) {
                loadQuestion(1, 0);
            } else if (gameNum === 2) {
                loadGame2Question(0);
            } else if (gameNum === 3) {
                loadGame3Question(0);
            } else if (gameNum === 4) {
                loadGame4Question(0);
            } else if (gameNum === 5) {
                loadGame5Question(0);
            }

            startTimer(gameNum);
        }

        function startTimer(gameNum) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                const timerEl = document.getElementById('game' + gameNum + 'Timer');
                if (timerEl) timerEl.textContent = timeStr;
                
                if (timeLeft <= 0) {
                    endGame(gameNum);
                }
            }, 1000);
        }

        function endGame(gameNum) {
            if (timerInterval) clearInterval(timerInterval);
            gameEndTime = new Date();
            
            const gameTime = Math.floor((gameEndTime - gameStartTime) / 1000);
            const accuracy = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
            const achievement = score >= 80 ? 'â­ íƒì›”' : score >= 60 ? 'ğŸ‘ ìš°ìˆ˜' : score >= 40 ? 'âœŒï¸ ì¢‹ìŒ' : 'ğŸ“š ë…¸ë ¥';

            if (firebaseReady && studentInfo.sessionId) {
                saveGameResult(studentInfo.sessionId, gameData[gameNum].name, score, accuracy, gameTime);
            }

            document.getElementById('finalScore').textContent = score;
            document.getElementById('resultGameName').textContent = gameData[gameNum].name;
            document.getElementById('resultTime').textContent = gameTime + 'ì´ˆ';
            document.getElementById('resultAccuracy').textContent = accuracy + '%';
            document.getElementById('resultAchievement').textContent = achievement;

            showPage('.result-page');
        }

        // ============ GAME 1: RACING QUIZ ============
        function loadQuestion(gameNum, questionIndex) {
            const game = gameData[gameNum];
            currentQuestion = questionIndex;
            selectedAnswer = null;

            if (gameNum === 1) {
                const q = game.questions[questionIndex];
                document.getElementById('game1QuestionNum').textContent = questionIndex + 1;
                document.getElementById('game1Question').textContent = q.text;
                
                const optionsHtml = q.options.map((opt, idx) => 
                    `<button class="option-btn" onclick="selectGame1Option(${idx})">${opt}</button>`
                ).join('');
                document.getElementById('game1Options').innerHTML = optionsHtml;
                
                const fb = document.getElementById('game1Feedback');
                fb.classList.remove('show', 'correct', 'incorrect');
                fb.textContent = '';
                const btn = document.getElementById('game1SubmitBtn');
                btn.disabled = false;
                btn.textContent = 'ë‹µë³€ ì œì¶œ';
                btn.onclick = submitGame1Answer;
            }
        }

        function selectGame1Option(optionIndex) {
            selectedAnswer = optionIndex;
            document.querySelectorAll('#game1Options .option-btn').forEach((btn, idx) => {
                btn.classList.toggle('selected', idx === optionIndex);
            });
        }

        function submitGame1Answer() {
            if (selectedAnswer === null) {
                alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const game = gameData[1];
            const correct = selectedAnswer === game.questions[currentQuestion].correct;
            
            totalAnswered++;
            if (correct) {
                correctAnswers++;
                score += 20;
            }

            const feedbackEl = document.getElementById('game1Feedback');
            const incorrectMsg = 'ì•„ì‰½ê²Œë„ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤!! í’€ì´ê³¼ì •ì„ ë³´ë©´ì„œ ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ ë´…ì‹œë‹¤.';
            feedbackEl.textContent = correct ? 'âœ… ì •ë‹µì…ë‹ˆë‹¤!' : incorrectMsg;
            feedbackEl.className = 'feedback show ' + (correct ? 'correct' : 'incorrect');

            if (!correct && game.questions[currentQuestion].explanation) {
                showExplainPopup(game.questions[currentQuestion].explanation);
            }

            document.getElementById('game1Score').textContent = score;
            document.getElementById('game1SubmitBtn').disabled = true;

            const progress = ((currentQuestion + 1) / 5) * 100;
            document.getElementById('racingTrack').style.transform = `translateX(${progress * 2}px)`;

            const btn = document.getElementById('game1SubmitBtn');
            if (currentQuestion < game.questions.length - 1) {
                btn.disabled = false;
                btn.textContent = 'ë‹¤ìŒ ë¬¸ì œ';
                btn.onclick = () => {
                    loadQuestion(1, currentQuestion + 1);
                };
            } else {
                btn.disabled = false;
                btn.textContent = 'ê²Œì„ ì™„ë£Œ';
                btn.onclick = () => endGame(1);
            }
        }

        // ============ GAME 2: RESOURCE ALLOCATION ============
        function loadGame2Question(questionIndex) {
            const game = gameData[2];
            const scenario = game.scenarios[questionIndex];
            currentQuestion = questionIndex;
            selectedAnswer = null;

            document.getElementById('game2Scenario').textContent = scenario.question;
            document.getElementById('game2Situation').textContent = scenario.situation;
            document.getElementById('game2Budget').textContent = '1,000ë§Œì›';

            const choicesHtml = scenario.choices.map((choice, idx) => 
                `<div class="choice-option" onclick="selectGame2Choice(${idx})">
                    <span>${choice.text}</span>
                    <span class="choice-risk">${choice.effect}</span>
                </div>`
            ).join('');
            document.getElementById('game2Options').innerHTML = choicesHtml;

            const fb = document.getElementById('game2Feedback');
            fb.classList.remove('show', 'correct', 'incorrect');
            fb.textContent = '';
            const btn = document.getElementById('game2SubmitBtn');
            btn.disabled = false;
            btn.textContent = 'ì„ íƒ ì™„ë£Œ';
            btn.onclick = submitGame2Choice;
        }

        function selectGame2Choice(optionIndex) {
            selectedAnswer = optionIndex;
            document.querySelectorAll('#game2Options .choice-option').forEach((el, idx) => {
                el.classList.toggle('selected', idx === optionIndex);
            });
        }

        function submitGame2Choice() {
            if (selectedAnswer === null) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const game = gameData[2];
            const correct = selectedAnswer === game.scenarios[currentQuestion].correct;
            
            totalAnswered++;
            if (correct) {
                correctAnswers++;
                score += 20;
            }

            const feedbackEl = document.getElementById('game2Feedback');
            const incorrectMsg = 'ì•„ì‰½ê²Œë„ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤!! í’€ì´ê³¼ì •ì„ ë³´ë©´ì„œ ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ ë´…ì‹œë‹¤.';
            feedbackEl.textContent = correct ? 'âœ… í›Œë¥­í•œ ì„ íƒì…ë‹ˆë‹¤!' : incorrectMsg;
            feedbackEl.className = 'feedback show ' + (correct ? 'correct' : 'incorrect');

            if (!correct && game.scenarios[currentQuestion].explanation) {
                showExplainPopup(game.scenarios[currentQuestion].explanation);
            }

            document.getElementById('game2Score').textContent = score;
            document.getElementById('game2SubmitBtn').disabled = true;

            const btn = document.getElementById('game2SubmitBtn');
            if (currentQuestion < game.scenarios.length - 1) {
                btn.disabled = false;
                btn.textContent = 'ë‹¤ìŒ ìƒí™©';
                btn.onclick = () => {
                    loadGame2Question(currentQuestion + 1);
                };
            } else {
                btn.disabled = false;
                btn.textContent = 'ê²Œì„ ì™„ë£Œ';
                btn.onclick = () => endGame(2);
            }
        }

        // ============ GAME 3: TIMING CHOICE ============
        function loadGame3Question(questionIndex) {
            const game = gameData[3];
            const scenario = game.scenarios[questionIndex];
            currentQuestion = questionIndex;
            selectedAnswer = null;

            document.getElementById('game3QuestionNum').textContent = questionIndex + 1;
            document.getElementById('game3MarketStatus').textContent = scenario.market;
            document.getElementById('game3Question').textContent = scenario.question;

            const choicesHtml = scenario.choices.map((choice, idx) => 
                `<div class="choice-option" onclick="selectGame3Choice(${idx})">
                    <span>${choice.text}</span>
                    <span class="choice-risk">${choice.effect}</span>
                </div>`
            ).join('');
            document.getElementById('game3Options').innerHTML = choicesHtml;

            const fb = document.getElementById('game3Feedback');
            fb.classList.remove('show', 'correct', 'incorrect');
            fb.textContent = '';
            const btn = document.getElementById('game3SubmitBtn');
            btn.disabled = false;
            btn.textContent = 'ì„ íƒ ì™„ë£Œ';
            btn.onclick = submitGame3Choice;
        }

        function selectGame3Choice(optionIndex) {
            selectedAnswer = optionIndex;
            document.querySelectorAll('#game3Options .choice-option').forEach((el, idx) => {
                el.classList.toggle('selected', idx === optionIndex);
            });
        }

        function submitGame3Choice() {
            if (selectedAnswer === null) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const game = gameData[3];
            const correct = selectedAnswer === game.scenarios[currentQuestion].correct;
            
            totalAnswered++;
            if (correct) {
                correctAnswers++;
                score += 20;
            }

            const feedbackEl = document.getElementById('game3Feedback');
            const incorrectMsg = 'ì•„ì‰½ê²Œë„ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤!! í’€ì´ê³¼ì •ì„ ë³´ë©´ì„œ ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ ë´…ì‹œë‹¤.';
            feedbackEl.textContent = correct ? 'âœ… ì™„ë²½í•œ íƒ€ì´ë°ì…ë‹ˆë‹¤!' : incorrectMsg;
            feedbackEl.className = 'feedback show ' + (correct ? 'correct' : 'incorrect');

            if (!correct && game.scenarios[currentQuestion].explanation) {
                showExplainPopup(game.scenarios[currentQuestion].explanation);
            }

            document.getElementById('game3Score').textContent = score;
            document.getElementById('game3SubmitBtn').disabled = true;

            const btn = document.getElementById('game3SubmitBtn');
            if (currentQuestion < game.scenarios.length - 1) {
                btn.disabled = false;
                btn.textContent = 'ë‹¤ìŒ ìƒí™©';
                btn.onclick = () => {
                    loadGame3Question(currentQuestion + 1);
                };
            } else {
                btn.disabled = false;
                btn.textContent = 'ê²Œì„ ì™„ë£Œ';
                btn.onclick = () => endGame(3);
            }
        }

        // ============ GAME 4: CUSTOMER SATISFACTION ============
        function loadGame4Question(questionIndex) {
            const game = gameData[4];
            const scenario = game.scenarios[questionIndex];
            currentQuestion = questionIndex;
            selectedAnswer = null;

            document.getElementById('game4QuestionNum').textContent = questionIndex + 1;
            document.getElementById('game4CurrentScore').textContent = scenario.currentSatisfaction + '%';
            document.getElementById('game4Progress').style.width = scenario.currentSatisfaction + '%';
            document.getElementById('game4Progress').textContent = scenario.currentSatisfaction + '%';
            document.getElementById('game4Question').textContent = scenario.question;

            const choicesHtml = scenario.choices.map((choice, idx) => 
                `<div class="choice-option" onclick="selectGame4Choice(${idx})">
                    <span>${choice.text}</span>
                    <span class="choice-risk">${choice.effect}</span>
                </div>`
            ).join('');
            document.getElementById('game4Options').innerHTML = choicesHtml;

            const fb = document.getElementById('game4Feedback');
            fb.classList.remove('show', 'correct', 'incorrect');
            fb.textContent = '';
            const btn = document.getElementById('game4SubmitBtn');
            btn.disabled = false;
            btn.textContent = 'ëŒ€ì‘ ì™„ë£Œ';
            btn.onclick = submitGame4Choice;
        }

        function selectGame4Choice(optionIndex) {
            selectedAnswer = optionIndex;
            document.querySelectorAll('#game4Options .choice-option').forEach((el, idx) => {
                el.classList.toggle('selected', idx === optionIndex);
            });
        }

        function submitGame4Choice() {
            if (selectedAnswer === null) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const game = gameData[4];
            const correct = selectedAnswer === game.scenarios[currentQuestion].correct;
            
            totalAnswered++;
            if (correct) {
                correctAnswers++;
                score += 20;
            }

            const feedbackEl = document.getElementById('game4Feedback');
            const incorrectMsg = 'ì•„ì‰½ê²Œë„ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤!! í’€ì´ê³¼ì •ì„ ë³´ë©´ì„œ ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ ë´…ì‹œë‹¤.';
            feedbackEl.textContent = correct ? 'âœ… ìµœê³ ì˜ ìš°ì„ ìˆœìœ„ íŒë‹¨ì…ë‹ˆë‹¤!' : incorrectMsg;
            feedbackEl.className = 'feedback show ' + (correct ? 'correct' : 'incorrect');

            if (!correct && game.scenarios[currentQuestion].explanation) {
                showExplainPopup(game.scenarios[currentQuestion].explanation);
            }

            document.getElementById('game4Score').textContent = score;
            document.getElementById('game4SubmitBtn').disabled = true;

            const btn = document.getElementById('game4SubmitBtn');
            if (currentQuestion < game.scenarios.length - 1) {
                btn.disabled = false;
                btn.textContent = 'ë‹¤ìŒ ìƒí™©';
                btn.onclick = () => {
                    loadGame4Question(currentQuestion + 1);
                };
            } else {
                btn.disabled = false;
                btn.textContent = 'ê²Œì„ ì™„ë£Œ';
                btn.onclick = () => endGame(4);
            }
        }

        // ============ GAME 5: COMPETITOR CHASE ============
        function loadGame5Question(questionIndex) {
            const game = gameData[5];
            const scenario = game.scenarios[questionIndex];
            currentQuestion = questionIndex;
            selectedAnswer = null;

            document.getElementById('game5RoundNum').textContent = questionIndex + 1;
            document.getElementById('game5MyRevenue').textContent = scenario.myRevenue + 'ë§Œì›';
            document.getElementById('game5CompRevenue').textContent = scenario.compRevenue + 'ë§Œì›';
            document.getElementById('game5Question').textContent = scenario.question;

            const choicesHtml = scenario.choices.map((choice, idx) => 
                `<div class="choice-option" onclick="selectGame5Choice(${idx})">
                    <span>${choice.text}</span>
                    <span class="choice-risk">${choice.effect}</span>
                </div>`
            ).join('');
            document.getElementById('game5Options').innerHTML = choicesHtml;

            const fb = document.getElementById('game5Feedback');
            fb.classList.remove('show', 'correct', 'incorrect');
            fb.textContent = '';
            const btn = document.getElementById('game5SubmitBtn');
            btn.disabled = false;
            btn.textContent = 'ì „ëµ ì„ íƒ';
            btn.onclick = submitGame5Choice;
        }

        function selectGame5Choice(optionIndex) {
            selectedAnswer = optionIndex;
            document.querySelectorAll('#game5Options .choice-option').forEach((el, idx) => {
                el.classList.toggle('selected', idx === optionIndex);
            });
        }

        // â–¶ ê²Œì„5ëŠ” ì–´ë–¤ ì „ëµì„ ê³¨ë¼ë„ ì •ë‹µ ì²˜ë¦¬ & ì ìˆ˜ ë¶€ì—¬
        function submitGame5Choice() {
            if (selectedAnswer === null) {
                alert('ì„ íƒì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            totalAnswered++;
            correctAnswers++;
            score += 20;

            const feedbackEl = document.getElementById('game5Feedback');
            feedbackEl.textContent = 'âœ… ì¢‹ì€ ì „ëµì…ë‹ˆë‹¤!';
            feedbackEl.className = 'feedback show correct';

            document.getElementById('game5Score').textContent = score;
            document.getElementById('game5SubmitBtn').disabled = true;

            const game = gameData[5];
            const btn = document.getElementById('game5SubmitBtn');
            if (currentQuestion < game.scenarios.length - 1) {
                btn.disabled = false;
                btn.textContent = 'ë‹¤ìŒ ë¼ìš´ë“œ';
                btn.onclick = () => {
                    loadGame5Question(currentQuestion + 1);
                };
            } else {
                btn.disabled = false;
                btn.textContent = 'ê²Œì„ ì™„ë£Œ';
                btn.onclick = () => endGame(5);
            }
        }

        // ============ SOS FUNCTION ============
        function callSOS(game, ev) {
            const sosBtn = ev && ev.currentTarget ? ev.currentTarget : null;
            
            if (firebaseReady && studentInfo.sessionId) {
                saveSOS(studentInfo.sessionId, studentInfo.name, game);
            }

            if (sosBtn) {
                sosBtn.textContent = 'âœ… SOS ìš”ì²­ë¨!';
                sosBtn.classList.add('active');
                
                setTimeout(() => {
                    sosBtn.textContent = 'ğŸ†˜ SOS';
                    sosBtn.classList.remove('active');
                }, 2000);
            }

            alert('ğŸ†˜ SOS ìš”ì²­ì´ êµìˆ˜ë‹˜ê»˜ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nê³§ ë„ì›€ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // ============ FIREBASE HELPER FUNCTIONS ============
        function saveStudentInfo(sessionId, name, school, email) {
            if (!firebaseReady || !database) {
                console.warn('Firebaseê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }
            
            database.ref('students/' + sessionId).set({
                name: name,
                school: school,
                email: email,
                loginTime: new Date().toISOString(),
                status: 'active',
                currentGame: 'none',
                score: 0,
                sosRequests: []
            }).catch(error => {
                console.error('í•™ìƒ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
            });
        }

        function updateGameStatus(sessionId, gameName, score) {
            if (!firebaseReady || !database) return;
            
            database.ref('students/' + sessionId).update({
                currentGame: gameName,
                score: score,
                lastUpdate: new Date().toISOString()
            }).catch(error => {
                console.error('ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            });
        }

        function saveSOS(sessionId, studentName, game) {
            if (!firebaseReady || !database) {
                alert('Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                return;
            }
            
            const sosId = 'sos_' + Date.now();
            database.ref('sos/' + sosId).set({
                studentId: sessionId,
                studentName: studentName,
                game: game,
                timestamp: new Date().toISOString(),
                resolved: false
            }).catch(error => {
                console.error('SOS ì €ì¥ ì‹¤íŒ¨:', error);
            });
        }

        function saveGameResult(sessionId, gameName, score, accuracy, time) {
            if (!firebaseReady || !database) return;
            
            database.ref('students/' + sessionId).update({
                lastGame: gameName,
                lastGameScore: score,
                accuracy: accuracy,
                completedTime: new Date().toISOString(),
                status: 'completed'
            }).catch(error => {
                console.error('ê²Œì„ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', error);
            });
        }

        function resolveSOSRequest(requestId) {
            if (!firebaseReady || !database) return;
            
            database.ref('sos/' + requestId).remove()
                .then(() => alert('SOS ìš”ì²­ì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.'))
                .catch(error => {
                    console.error('SOS ì‚­ì œ ì‹¤íŒ¨:', error);
                });
        }
    </script>
</body>
</html>
